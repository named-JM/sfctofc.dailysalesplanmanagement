@page "/"

@using SFCTOFC.DailySalesPlanManagement.Server.UI.Pages.Dashboard.Components
@using SFCTOFC.DailySalesPlanManagement.Application.Common.Security
@using SFCTOFC.DailySalesPlanManagement.Application.Common.Interfaces.Identity
@using SFCTOFC.DailySalesPlanManagement.Application.Features.Tenants.DTOs
@using SFCTOFC.DailySalesPlanManagement.Application.Common.Interfaces
@using MudBlazor.Utilities

@using SFCTOFC.DailySalesPlanManagement.Application.Features.DSPM.DTOs;
@using SFCTOFC.DailySalesPlanManagement.Application.Features.DSPM.Queries.Pagination;

@inject IStringLocalizer<Dashboard> L
@inject IUserProfileState UserProfileState
@inject ITenantSwitchService TenantSwitchService

<style>
    @@import url("https://cdn.jsdelivr.net/npm/@@fancyapps/ui@@5.0.36/dist/fancybox/fancybox.css");

    .fancybox__container {
        --fancybox-bg: rgba(24, 24, 27, 0.85);
        z-index: 9999;
    }

    html, body {
        -moz-osx-font-smoothing: grayscale; /* Firefox on macOS */
        -webkit-font-smoothing: antialiased; /* Chrome, Edge, Safari */
        text-rendering: optimizeLegibility;
    }

    body {
        font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
        font-size: 12px;
    }

    .mud-menu .mud-icon-button {
        border-radius: 0 !important;
    }

    .search .mud-input {
        line-height: 1px !important;
    }

    .small-input .mud-input-slot {
        min-height: 28px !important;
        font-size: 0.8rem !important;
    }

    .small-input input {
        padding: 2px 6px !important;
    }

    .mud-card-content {
        flex-grow: 1;
        padding: 17px;
        margin-top: -36px !important;
    }

    .mud-input-control > .mud-input-control-input-container > .mud-input-label-inputcontrol {
        font-size: 1rem !important;
        font-weight: 600;
    }

    .mud-table.mud-data-grid .mud-table-toolbar {
        padding: 0rem !important;
    }

    .mud-table-root {
        margin-top: 1.3ewm !important;
    }

    .mud-table thead th {
        /* background-color: #c3c3c3 !important; */
        /* background-color: #dddddd !important;  */
        color: black !important;
        font-weight: 600;
        /* border: 1px solid #ccc; */
        /* border-top: 1px solid #eaeaea; */
    }

    .force-row {
        display: flex !important;
        flex-direction: row !important;
    }

    .gap-20 {
        column-gap: 190px;
    }

    .gap-21 {
        column-gap: 207px;
    }

    .gap-22 {
        column-gap: 140px;
    }

    .gap-19 {
        /* column-gap: 159px; */
    }

    .mud-table-bordered th,
    .mud-table-bordered td {
        align-content: flex-start;
        border: 1px solid #E3E3E3;
        padding: 6px;
    }

    .mud-table-bordered {
        border-collapse: collapse;
        width: 100%;
    }

    .compact-padding {
        padding: 9px 16px 0px 16px;
    }


    .ultra-compact-grid .mud-table-row {
        height: 26px !important;
    }

    .ultra-compact-grid .mud-table-cell {
        padding: 2px 6px !important;
        font-size: 0.75rem !important;
    }

    .mud-data-grid .mud-table-foot {
        display: none !important;
    }

    .mud-table.mud-table-striped tbody tr:nth-child(odd) {
        background-color: #fafafa !important;
    }

    .mud-table.mud-table-striped tbody tr:nth-child(even) {
        background-color: #ebebeb !important;
    }

    .mud-table.mud-table-hover tbody tr:hover {
        background-color: #00baef !important;
        color: white;
        cursor: pointer;
    }

    .mud-datagrid-header {
        border-bottom: 1px solid #E6E6E6;
    }

    .mud-datagrid-pager .mud-select {
        margin-left: auto !important;
    }

    .custom-pager .mud-datagrid-pager {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">

<PageTitle>@Title</PageTitle>

<ErrorBoundary>

    <MudDataGrid T="SalesmanTrackerDto" Class="ultra-compact-grid compact-padding mud-datagrid-header" ServerData="@(ServerReload)"
                 FixedHeader="true" FixedFooter="false" Loading="@_loading" ColumnResizeMode="ResizeMode.Column" 
                 Striped="true" Dense="true" Hover="true" @ref="_dataGridSalesmanTracket" RowsPerPage="15" Style="height:100%; overflow:auto;">
        
        <ToolBarContent>
            <MudStack Row Spacing="0" Class="flex-grow-1" Justify="Justify.SpaceBetween">
                <MudStack Row AlignItems="AlignItems.Start">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.h3" Class="mb-2 fw-bold"><b>Salesman Activities</b></MudText>
                        <div style="width: fit-content;">

                            @* ==================================================== *@
                            @* == HERE IS THE ROW FOR SEARCH AND ADD JOB REQUEST *@
                            @* ==================================================== *@
                            <MudStack Row Spacing="1">
                                @* SEACH FIELD *@
                                @if (_accessRights.Search)
                                {
                                    <MudTextField T="string"
                                                  Variant="Variant.Outlined"
                                                  Dense="true"
                                                  Class="search small-input mt-3 mb-4"
                                                  @bind-Value="_paginationQuery.Keyword"
                                                  Placeholder="@ConstantString.Search"
                                                  Adornment="Adornment.End"
                                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                                  IconSize="Size.Small"
                                                  Immediate="true"
                                                  Clearable="true">
                                    </MudTextField>

                                }
                            </MudStack>
                        </div>
                    </MudStack>
                </MudStack>
            </MudStack>
        </ToolBarContent>

    </MudDataGrid>
    
    @* <MudGrid Style="padding:16px;">
        <MudItem xs="12" sm="6">
            <MudText Typo="Typo.h3" Style="color: white;">
                Welcome, <span style="color: orangered;">@UserProfile?.DisplayName</span>!
            </MudText>
       </MudItem>
        <MudItem xs="12" sm="6">
            <MudGrid>
                <MudItem xs="12" sm="6">
                </MudItem>
                <MudItem xs="12" sm="6" Class="d-flex flex-column justify-center align-center">
                    <MudText Typo="Typo.h1" Style="
                        color: white;
                        font-weight: 700;
                        font-family: 'Segoe UI', 'Roboto', sans-serif;
                        font-size: 4rem;
                        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
                        ">
                        @CurrentTime
                    </MudText>

                    <!-- Announcement Card -->
                    <MudCard Style="margin-top: 16px; backdrop-filter: blur(10px); background-color: rgba(255, 255, 255, 0.05); border-radius: 12px; color: white; width: 100%;">
                        <MudCardContent>
                            <!-- Top Row: View All -->
                            <MudStack Direction="Row" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.subtitle2" Class="text-uppercase" Style="opacity: 0.8;">Announcements :</MudText>
                                <MudLink Href="/announcements" Style="font-size: 0.875rem; font-weight: 500; color: var(--mud-palette-primary);">
                                    View All
                                </MudLink>
                            </MudStack>

                            <MudDivider Class="my-2" />

                            <!-- Title -->
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                CORPORATE SOLUTIONS
                            </MudText>

                            <!-- Date -->
                            <MudText Typo="Typo.caption" Class="mud-secondary-text" Style="margin-bottom: 6px;">
                                April 29, 2024
                            </MudText>

                            <!-- Content Preview -->
                            <MudText Typo="Typo.body2" Style="opacity: 0.9;">
                                In-house development of ERP application is still ongoing, modular and routine structure designing...
                            </MudText>

                            <!-- View More -->
                            <MudLink Href="/announcements/details" Style="font-size: 0.875rem; color: var(--mud-palette-primary); font-weight: 500;">
                                view more
                            </MudLink>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </MudItem>
   </MudGrid> *@

</ErrorBoundary>


@code {

    public string Title { get; set; } = "Salesman Activities";
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter] private UserProfile? UserProfile { get; set; }
    private ProductsAccessRights _accessRights = new();
    private PaginationQuerySalesmanTracker _paginationQuery { get; } = new();
    private bool _loading;

    private List<SalesmanTrackerDto> _List = new();
    private MudDataGrid<SalesmanTrackerDto> _dataGridSalesmanTracket = default!;

    protected override void OnInitialized()
    {
        UserProfileState.Changed += OnUserProfileChanged;
        base.OnInitialized();
    }

    protected override async Task OnInitializedAsync()
    {
        UserProfileState.Changed += OnUserProfileChanged;
    }

    public void Dispose()
    {
        UserProfileState.Changed -= OnUserProfileChanged;
    }

    private void OnUserProfileChanged(object? sender, UserProfile userProfile)
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task<GridData<SalesmanTrackerDto>> ServerReload(GridState<SalesmanTrackerDto> state)
    {
        try
        {
            _loading = true;
            _paginationQuery.CurrentUser = UserProfile;
            _paginationQuery.OrderBy = state.SortDefinitions.FirstOrDefault()?.SortBy ?? "Id";
            _paginationQuery.SortDirection = state.SortDefinitions.FirstOrDefault()?.Descending ?? true
                                              ? SortDirection.Descending.ToString()
                                              : SortDirection.Ascending.ToString();
            _paginationQuery.PageNumber = state.Page + 1;
            _paginationQuery.PageSize = state.PageSize;

            var result = await Mediator.Send(_paginationQuery).ConfigureAwait(false);
            _List = result.Items?.ToList() ?? new List<SalesmanTrackerDto>();
            return new GridData<SalesmanTrackerDto> { TotalItems = result.TotalItems, Items = _List };
        }
        finally
        {
            _loading = false;
        }
    }
}
