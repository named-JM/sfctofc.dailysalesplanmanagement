@page "/"

@using SFCTOFC.DailySalesPlanManagement.Server.UI.Pages.Dashboard.Components
@using SFCTOFC.DailySalesPlanManagement.Application.Common.Security
@using SFCTOFC.DailySalesPlanManagement.Application.Common.Interfaces.Identity
@using SFCTOFC.DailySalesPlanManagement.Application.Common.Interfaces
@using SFCTOFC.DailySalesPlanManagement.Application.Features.Tenants.DTOs
@using MudBlazor.Utilities

@using SFCTOFC.DailySalesPlanManagement.Application.Features.DSPM.DTOs;
@using SFCTOFC.DailySalesPlanManagement.Application.Features.DSPM.Queries.Pagination;

@inject IStringLocalizer<Dashboard> L
@inject IUserProfileState UserProfileState
@inject ITenantSwitchService TenantSwitchService

<style>
    @@import url("https://cdn.jsdelivr.net/npm/@@fancyapps/ui@@5.0.36/dist/fancybox/fancybox.css");

    .fancybox__container {
        --fancybox-bg: rgba(24, 24, 27, 0.85);
        z-index: 9999;
    }

    html, body {
        -moz-osx-font-smoothing: grayscale; /* Firefox on macOS */
        -webkit-font-smoothing: antialiased; /* Chrome, Edge, Safari */
        text-rendering: optimizeLegibility;
    }

    body {
        font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
        font-size: 12px;
    }

    .mud-menu .mud-icon-button {
        border-radius: 0 !important;
    }

    .search .mud-input {
        line-height: 1px !important;
    }

    .small-input .mud-input-slot {
        min-height: 28px !important;
        font-size: 0.8rem !important;
    }

    .small-input input {
        padding: 2px 6px !important;
    }

    .mud-card-content {
        flex-grow: 1;
        padding: 17px;
        margin-top: -36px !important;
    }

    .mud-input-control > .mud-input-control-input-container > .mud-input-label-inputcontrol {
        font-size: 1rem !important;
        font-weight: 600;
    }

    .mud-table.mud-data-grid .mud-table-toolbar {
        padding: 0rem !important;
    }

    .mud-table-root {
        margin-top: 1.3ewm !important;
    }

    .mud-table thead th {
        /* background-color: #c3c3c3 !important; */
        /* background-color: #dddddd !important;  */
        color: black !important;
        font-weight: 600;
        /* border: 1px solid #ccc; */
        /* border-top: 1px solid #eaeaea; */
    }

    .force-row {
        display: flex !important;
        flex-direction: row !important;
    }

    .gap-20 {
        column-gap: 190px;
    }

    .gap-21 {
        column-gap: 207px;
    }

    .gap-22 {
        column-gap: 140px;
    }

    .gap-19 {
        /* column-gap: 159px; */
    }

    .mud-table-bordered th,
    .mud-table-bordered td {
        align-content: flex-start;
        border: 1px solid #E3E3E3;
        padding: 6px;
    }

    .mud-table-bordered {
        border-collapse: collapse;
        width: 100%;
    }

    .compact-padding {
        padding: 9px 16px 0px 16px;
    }


    .ultra-compact-grid .mud-table-row {
        height: 26px !important;
    }

    .ultra-compact-grid .mud-table-cell {
        padding: 2px 6px !important;
        font-size: 0.75rem !important;
    }

    .mud-data-grid .mud-table-foot {
        display: none !important;
    }

    .mud-table.mud-table-striped tbody tr:nth-child(odd) {
        background-color: #fafafa !important;
    }

    .mud-table.mud-table-striped tbody tr:nth-child(even) {
        background-color: #ebebeb !important;
    }

    .mud-table.mud-table-hover tbody tr:hover {
        background-color: #00baef !important;
        color: white;
        cursor: pointer;
    }

    .mud-datagrid-header {
        border-bottom: 1px solid #E6E6E6;
    }

    .mud-datagrid-pager .mud-select {
        margin-left: auto !important;
    }

    .custom-pager .mud-datagrid-pager {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">

<PageTitle>@Title</PageTitle>

<ErrorBoundary>
    <MudCard>
        <MudCardContent>
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-7 mt-7">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.CoPresent" Color="Color.Primary" Size="Size.Large" />
                    <MudText Typo="Typo.h3" Style="color: black;">
                        Welcome, <span style="color: orangered;">@UserProfile?.DisplayName</span>!
                    </MudText>
                </MudStack>
            </MudStack>
        </MudCardContent>
    </MudCard>

    <DashboardSalesmanActivity />

    <MudDataGrid T="SalesmanTrackerDto" Class="ultra-compact-grid compact-padding mud-datagrid-header" ServerData="@(ServerReload)"
                 FixedHeader="true" FixedFooter="false" Loading="@_loading" ColumnResizeMode="ResizeMode.Column" 
                 Striped="true" Dense="true" Hover="true" @ref="_dataGridSalesmanTracket" RowsPerPage="20" Style="height:100%; overflow:auto;">
        <ToolBarContent>
            <MudStack Row Spacing="0" Class="flex-grow-1 mb-5" Justify="Justify.SpaceBetween">
                <MudStack Row AlignItems="AlignItems.End">
                    <MudStack Spacing="0">
                        <div style="width: fit-content; margin: 0 auto;">
                            <MudStack Row Spacing="0" Class="force-row" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h5" Class="mb-2 fw-bold"><b>Todays Plan</b></MudText>

                                <MudToolBar Dense WrapContent="true" Class="py-1 px-0">
                                    <MudDatePicker Label="Date" Class="ml-4" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                </MudToolBar>
                            </MudStack>
                        </div>
                    </MudStack>
                </MudStack>
                <MudStack Row AlignItems="AlignItems.Start">
                    <MudStack Spacing="0">
                        @* <MudText Typo="Typo.h3" Class="mb-2 fw-bold"><b>Salesman Activities</b></MudText> *@
                        <div style="width: fit-content;">
                            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                @* SEACH FIELD *@
                                <MudTextField T="string"
                                              Variant="Variant.Outlined"
                                              Dense="true"
                                              Class="search small-input mt-3 mb-4 mr-5"
                                              @bind-Value="_paginationQuery.Keyword"
                                              Placeholder="@ConstantString.Search"
                                              Adornment="Adornment.End"
                                              AdornmentIcon="@Icons.Material.Filled.Search"
                                              IconSize="Size.Small"
                                              Immediate="true"
                                              Clearable="true">
                                </MudTextField>

                                <MudTooltip Text="Refresh Dashboard">
                                    <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                                   Color="Color.Primary"
                                                   Size="Size.Small" />
                                </MudTooltip>
                            </MudStack>
                        </div>
                    </MudStack>
                </MudStack>
            </MudStack>
        </ToolBarContent>

        <Columns>
            <PropertyColumn HeaderStyle="font-weight: bold; width: 106px;" Property="x => x.Name" Title="Salesman" />
            @* <PropertyColumn HeaderStyle="font-weight: bold; width: 106px;" Property="x => x.Date" Title="Date">
                <CellTemplate>
                    @(context.Item.Date?.ToString("MMM dd, yyyy") ?? "")
                </CellTemplate>
            </PropertyColumn> *@
            <PropertyColumn HeaderStyle="font-weight: bold; width: 106px;" Property="x => x.TargetSales" Title="Target Sales" />
            <PropertyColumn HeaderStyle="font-weight: bold; width: 106px;" Property="x => x.ActualSales" Title="Actual Sales" />
            <PropertyColumn HeaderStyle="font-weight: bold; width: 106px;" Property="x => x.TargetStoreVisited" Title="Scheduled" />
            <PropertyColumn HeaderStyle="font-weight: bold; width: 106px;" Property="x => x.ActualStoreVisited" Title="Visited" />
            <PropertyColumn HeaderStyle="font-weight: bold; width: 106px;" Property="x => x.Skipped" Title="Skipped" />
        </Columns>

        <NoRecordsContent>
            <MudText>@ConstantString.NoRecords</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>@ConstantString.Loading</MudText>
        </LoadingContent>
        <PagerContent>
            <MudDataGridPager PageSizeOptions="@(new[] { 10, 20, 30, 50 })" Class="custom-pager" />
        </PagerContent>
    </MudDataGrid>
</ErrorBoundary>


@code {
    public string Title { get; set; } = "Salesman Activities";
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter] private UserProfile? UserProfile { get; set; }
    private ProductsAccessRights _accessRights = new();
    private PaginationQuerySalesmanTracker _paginationQuery { get; } = new();
    private bool _loading;

    private List<SalesmanTrackerDto> _List = new();
    private MudDataGrid<SalesmanTrackerDto> _dataGridSalesmanTracket = default!;

    protected override void OnInitialized()
    {
        UserProfileState.Changed += OnUserProfileChanged;
        base.OnInitialized();
    }

    protected override async Task OnInitializedAsync()
    {
        UserProfileState.Changed += OnUserProfileChanged;
    }

    public void Dispose()
    {
        UserProfileState.Changed -= OnUserProfileChanged;
    }

    private void OnUserProfileChanged(object? sender, UserProfile userProfile)
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task<GridData<SalesmanTrackerDto>> ServerReload(GridState<SalesmanTrackerDto> state)
    {
        try
        {
            _loading = true;
            _paginationQuery.CurrentUser = UserProfile;
            _paginationQuery.OrderBy = state.SortDefinitions.FirstOrDefault()?.SortBy ?? "Id";
            _paginationQuery.SortDirection = state.SortDefinitions.FirstOrDefault()?.Descending ?? true
                                              ? SortDirection.Descending.ToString()
                                              : SortDirection.Ascending.ToString();
            _paginationQuery.PageNumber = state.Page + 1;
            _paginationQuery.PageSize = state.PageSize;

            var result = await Mediator.Send(_paginationQuery).ConfigureAwait(false);
            _List = result.Items?.ToList() ?? new List<SalesmanTrackerDto>();
            return new GridData<SalesmanTrackerDto> { TotalItems = result.TotalItems, Items = _List };
        }
        finally
        {
            _loading = false;
        }
    }
}
